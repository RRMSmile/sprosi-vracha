name: Deploy Sprosivracha to Beget

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci

      - name: Build Next.js (static export via next.config.js output: 'export')
        run: npm run build

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # create host alias 'beget'
          printf "Host beget\n  HostName ${{ secrets.BEGET_HOST }}\n  User ${{ secrets.BEGET_USER }}\n  IdentityFile ~/.ssh/id_ed25519\n  StrictHostKeyChecking no\n" > ~/.ssh/config
        shell: bash

      - name: Check SSH access (will fail early if key not accepted)
        run: |
          set -euo pipefail
          ssh -o BatchMode=yes -o ConnectTimeout=10 beget "echo SSH_OK"
        shell: bash

      - name: Clean remote folder
        run: ssh beget "rm -rf /home/e/${{ secrets.BEGET_USER }}/data/www/sprosi-vracha.com/*"
        shell: bash

      - name: Upload site (scp)
        run: scp -r ./out/* beget:/home/e/${{ secrets.BEGET_USER }}/data/www/sprosi-vracha.com/

      - name: Notify Telegram (success)
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d parse_mode="Markdown" \
            -d text="✅ Деплой завершён: sprosi-vracha.com"
